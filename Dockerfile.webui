# 基于现有镜像或从头构建
FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt tool_server_lite/requirements.txt web_ui/requirements.txt /app/

# 复制整个项目
COPY . /app/

# 安装 Python 依赖（包括 Web UI）
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -e . && \
    pip install --no-cache-dir supervisor && \
    pip install --no-cache-dir -r web_ui/requirements.txt

# 安装 Playwright 及浏览器
RUN playwright install --with-deps chromium

# 创建必要的目录
RUN mkdir -p /root/.config/mla /root/mla_v3 /workspace /mla_config /var/log/supervisor /var/run

# 复制 supervisor 配置（如果需要）
COPY docker/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# 设置工作目录
WORKDIR /workspace

# 复制并设置权限
COPY docker/entrypoint-webui.sh /entrypoint.sh
COPY docker/init-config.sh /init-config.sh
RUN chmod +x /entrypoint.sh /init-config.sh

# 暴露端口
EXPOSE 8002 9641 22228

# 设置入口点
ENTRYPOINT ["/entrypoint.sh"]
CMD ["webui"]

